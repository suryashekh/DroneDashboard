Based on the discussion and your current situation, here are several key things you can try to improve RTK accuracy with your Here+ setup:

Base Station Optimization:


Raise the elevation mask angle from the default 5 degrees to 13-15 degrees (13 degrees seems to be a good balance according to testing)
Use a proper ground plane for the base station (at least 13cm diameter metallic surface)
Mount the base station higher (around 1.8m above ground) with clear sky view
Ensure the base station has a good signal strength (aiming for 13+ satellites above 40 SNR)


Rover/Drone Setup:


Ensure proper ground plane/shielding for the GPS on drones (the copper shielding you have is good)
Keep other electronics and especially telemetry radios away from the GPS antenna
Limit bank angles to 30 degrees to maintain better satellite lock
Consider increasing the WPNAV_RADIUS parameter if you're following waypoints


RTK Settings:


Set Signal-to-Noise (SNR) threshold to around 35-40
Use firmware version 1.4 on the NEO-M8P (as v1.3 had a fix-related bug)
Consider limiting flight operations to times when you have good satellite coverage
Give the system time to achieve and maintain fix (L1 RTK can take 10+ minutes)


MQTT/Communication Optimization:


Increase the correction message rate if possible
At 1.5m/s movement speed, you'll want corrections at least 5-10 times per second
Ensure minimal latency in the MQTT network
Check that the ESP32 is processing and forwarding the corrections without delays

Expected Accuracy Improvements:

Best case (RTK Fixed):


Horizontal: ~2-5cm
Vertical: ~5-10cm


RTK Float:


Horizontal: ~20-50cm
Vertical: ~50-100cm

Important Notes:

The Here+ being an L1-only receiver will have inherent limitations
Even with perfect settings, achieving and maintaining RTK Fixed state can be challenging
You may need to balance between position accuracy and fix stability
Consider environmental factors like multipath, obstructions, and time of day

For testing, I recommend:

Start with base station optimizations first
Then implement the elevation mask and SNR changes
Test with a stationary drone before moving tests
Monitor the fix percentage over time
Document position drift in both RTK Float and Fixed states

Would you like me to elaborate on any of these points or provide more specific implementation details for any particular aspect?

==========================================
Based on your test results and the directional accuracy issues, here are specific recommendations to improve heading/directional accuracy:

Compass/Magnetometer Calibration:


The heading inaccuracy you're seeing (45° left to 30° right variations) strongly suggests compass calibration issues
Perform a thorough compass calibration before flights
Do the calibration away from magnetic interference
Consider doing both normal compass calibration and motor/interference calibration
Check your compass's health in Mission Planner's HUD


GPS Base Station Setup:

pythonCopy# Important parameters to check/modify
GPS_AUTO_CONFIG = 1  # Enable GPS auto configuration
GPS_AUTO_SWITCH = 1  # Enable automatic GPS blending/switching
COMPASS_ORIENT = 0   # Verify compass orientation is set correctly
COMPASS_DEC = 0      # Set correct magnetic declination for your location

RTK Configuration Improvements:

pythonCopy# Key parameters for improved heading accuracy
GPS_TYPE = 17        # Set to RTK GPS type
GPS_POS1_X = 0      # Verify GPS position offset from FC
GPS_POS1_Y = 0      # Should be 0 if mounted directly above FC
GPS_POS1_Z = 0      # Height offset if any

Testing Protocol:

pythonCopy# Systematic testing approach
1. Start with base station powered for 15+ minutes
2. Wait for RTK float/fixed status
3. Take off to 5m
4. Hold position for 30 seconds
5. Move 5m south (use visual markers)
6. Hold position for 30 seconds
7. Land
8. Record:
   - Initial RTK status
   - Compass heading
   - Final position error

Physical Setup Improvements:


Mount GPS units with clear view of the sky
Ensure base station is perfectly level
Mark true south direction using a surveyor's compass
Set up visual markers for desired flight path
Maintain minimum 2m separation between base and rover


Parameters to Monitor:


GPS_RAW message in MAVLink for number of satellites
RTK baseline length
Compass variance
EKF status and variances


Heading Check Process:

pythonCopy# Pre-flight heading verification
1. Point drone to known direction (true south)
2. Check heading in Mission Planner
3. Record offset if any
4. Rotate drone 90° and verify heading change
5. Return to original position and recheck

Environmental Considerations:


Test away from metal structures
Avoid power lines and magnetic interference
Test at different times of day
Document weather conditions


Logging and Analysis:

pythonCopy# Enable detailed logging
LOG_BITMASK = 65535  # Full logging
GPS_RAW_DATA = 1     # Enable raw GPS data logging

# Key data points to analyze
- GPS status transitions
- Compass heading variations
- Position drift patterns
- RTK correction reception rate

Troubleshooting Priority:
First verify compass calibration
Then check RTK correction flow
Monitor satellite count and geometry
Verify GPS antenna orientation
Check for interference sources

To implement these improvements:

Immediate Actions:

bashCopy# Base station setup
1. Level base station
2. Mark true south reference
3. Wait 15 minutes for stabilization
4. Verify RTK corrections flow

# Drone setup
1. Perform compass calibration
2. Verify GPS antenna orientation
3. Check all cable connections
4. Confirm proper receiver configuration

Parameter Updates:

pythonCopy# Key parameters to modify
COMPASS_LEARN = 0    # Disable automatic learning
COMPASS_AUTODEC = 1  # Enable automatic declination
EK2_MAG_CAL = 2     # More conservative mag fusion
Would you like me to provide more detailed information about any of these aspects or help create a specific testing protocol for your setup?
